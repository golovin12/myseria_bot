# Телеграм бот, для получения информации о новых сериях для отслеживаемых сериалов

## Конфигурация окружений:

* DOCKER - рабочее окружение для запуска в Docker-контейнерах.
* LOCAL - окружение для запуска на локальной машине.
* TEST - заглушка, для запуска тестов.

Конфигурационные файлы веб окружений находятся в config/settings_<env_name>.py

## Технологический стек:

* balancer
    - nginx
* worker
    - фреймворк - dramatiq
* queue
    - rabbitmq - брокер сообщений
* web
    - ASGI-сервер (uvicorn), фреймворк fastAPI
* bots
    - webhooks, фреймворк aiogram
* database
    - redis - хранение данных пользователей
* fsm-storage
    - redis - хранение состояний Telegram-ботов
* log
    - Логи записываются в файлы логов.

## Схема взаимодействия

![Alt text](/schema.png?raw=true "Пример использования бота")

## Запуск с помощью Docker

> docker-compose up

## Запуск с локальной машины:

Запуск воркеров (используют RabbitMQ):
> python -m management.run_dramatiq

Запуск ботов:
> python -m run

## Переменные окружений:

Перед запуском необходимо задать переменные окружения:

1) MY_SERIA_BOT_TOKEN - токен бота юзеров для сайта MySeria
2) ZETFLIX_BOT_TOKEN - токен бота юзеров для сайта Zetflix
3) ADMIN_BOT_TOKEN - токен бота админов

Необязательные параметры:

4) SECRET_TOKEN - Токен, для проверки того, что webhook установлен нами
5) SKIP_UPDATES - Нужно ли пропускать необработанные сообщения
6) ADMIN_ID - id юзера, которому откроется доступ к админовскому боту и будут отправляться логи
7) VK_ACCESS_TOKEN - ключ доступа к VK API для динамического обновления адресов сайтов с сериалами
8) USE_NGROK - следует ли использовать ngrok (подходит для dev окружения, не требует настройки маршрутизации)
9) PUBLIC_HOST - публичный IP, к которому будет обращаться Telegram-сервер
10) PUBLIC_PORT - порт (80, 88, 443, 8443), к которому будет обращаться Telegram-сервер
11) LOCAL_HOST - адрес, на котором запустится uvicorn
12) SSL_PUBLIC_PATH - путь до сертификата
13) SSL_PRIVATE_PATH - путь до ключа

## Информация

Телеграм общается с нами по https протоколу.
* Есть возможность использовать самоподписанный сертификат: https://core.telegram.org/bots/self-signed

* При первом запуске для работы ботов нужно задать адреса сайтов с сериалами для данных ботов. Актуальные адреса на
  05.11.2023:
    * MySeria - https://serialrun.ru/
    * Zetflix - https://zetfix.online/
* Если задан VK_ACCESS_TOKEN, то адреса сайтов обновятся автоматически
* Иначе можно задать адреса сайтов введя команду в админовском боте #new_..._addr: https://...

## Пример работы бота:

![Alt text](/bot.png?raw=true "Пример использования бота")

### TODO:

* настроить сохранение логов в отдельном контейнере
* настроить отправку логов на почту
* тестирование для bot.handlers, bot.middlewares и serial_services.service
* парсинг озвучек из Zetflix
* разделить хранение сериалов юзера относительно сайтов
* добавить возможность задать вопрос админам (из ботов юзеров)
* Запускать ботов из разных контейнеров (для каждого бота свой контейнер)
